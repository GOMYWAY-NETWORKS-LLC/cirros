#!/bin/bash

[ $# -ge 1 ] || { echo "must give version"; exit 1; }

VER=$1
daily=false
if [ "$1" = "daily" ]; then
   VER="d$(date +%y%m%d)"
   daily=true
fi
shift
pre=cirros-$VER
BR_VER="2015.05"
ARCHES="${ARCHES:-i386 x86_64 arm powerpc aarch64 ppc64 ppc64le}"
KVER="4.4.0-28.47"
ME=$(readlink -f "$0")
MY_D=${ME%/*}
PATH=${MY_D}:$PATH

set -e
set -o pipefail

OUT="$PWD/../build-$VER"
LOGFILE="$OUT/date.txt"
export TMPDIR="$OUT/tmp"
mkdir -p "$OUT" "$TMPDIR"

dl() {
   local url="$1" target="$2" tfile="" t=""
   [ -f "$target" ] && return
   t=$(dirname "$target")
   tfile=$(mktemp "$t/.${0##*/}.XXXXXX") || return
   wget "$url" -O "$tfile" &&
      mv "$tfile" "$target" ||
      { t=$?; rm -f "$tfile"; return $t; }
}
msg() {
   echo "$@" >> "$LOGFILE"
   echo "$@"
}
logevent() {
   # logevent(msg, [from])
   # log the message in $1 and time since $2, defaulting to last call.
   local up delta msg="$1" ref="$2"
   up=${SECONDS}
   if [ "$ref" = "-" ]; then
      ref=""
   elif [ "$ref" = "" ]; then
      ref="${_LAST_UP}"
   fi
   if [ -n "$ref" ]; then
      delta="$(($up-$ref))"
   fi
   msg "$(date -R)" "$msg" "${delta:+[${delta}s]}"
   _LAST_UP=$up
   _RET=${_LAST_UP}
}

error() { echo "$@" 1>&2; }
fail() { [ $# -eq 0 ] || error "$@"; exit 1; }

build_arch() {
    local arch="" quiet=false cmd="" log=""
    if [ "$1" = "quiet" ]; then
        quiet=true
        shift
    fi
    arch="$1"
    log="${OUT}/build-$arch.log"
    cmd=( make ARCH=$arch "OUT_D=$OUT/build/$arch" \
        ${CCACHE_D:+"BR2_CCACHE_DIR=${CCACHE_D}/$arch"} )

    logevent "start $arch" -
    if $quiet; then
        error "building $arch into $log"
        time "${cmd[@]}" > "$log" 2>&1
    else
        time "${cmd[@]}" 2>&1 | tee "$log"
    fi
    ret=$?
    logevent "finish $arch [ret=$ret]"
    return $ret
}

if [ "$1" = "build_arch" ]; then
    shift
    build_arch "$@"
    exit
elif [ $# -gt 1 ]; then
    fail "confused by $# arguments: $*"
fi

# really just here to check that VER is a tag
# or source code checkout would fail
if ! $daily; then
    revno=$(bzr tags -r "tag:$VER") || fail "$VER: not a tag in $PWD."
    revno=$(echo "$revno" | awk '{print $2}')
fi

logevent "begin" -
tstart=${_RET}

logevent "start download" -
rm -f download
mkdir -p ../download
ln -snf ../download download
brtgz="buildroot-${BR_VER}.tar.gz"
dl "http://buildroot.uclibc.org/downloads/$brtgz" "download/$brtgz"
logevent "end download"

logevent "start unpack" -
rm -Rf "buildroot-${BR_VER}"
rm -f buildroot
tar -xvf download/buildroot-${BR_VER}.tar.gz
ln -snf buildroot-${BR_VER} buildroot

# we do not do this here, so that we're not dependent on the
# cvs working (which wont work through http_proxy) and also
# to have revision controlled information in that file.
#./bin/mkcabundle > src/etc/ssl/certs/ca-certificates.crt

( cd buildroot && QUILT_PATCHES="$PWD/../patches-buildroot" quilt push -a )

echo "$VER" > "src/etc/cirros/version"
logevent "end unpack"

logevent "start br-source" -
make ARCH=i386 br-source
logevent "end br-source"

logevent "start kernel download" -
grab-kernels "$KVER" ${ARCHES}
logevent "end kernel download"

jobs_flag=""
parallel=true
case "${CIRROS_PARALLEL:-none}" in
    none) parallel=false;;
    0|true) :;;
    [0-9]|[0-9][0-9]) jobs_flag="--jobs=${CIRROS_PARALLEL}";;
    auto) command -v parallel >/dev/null || parallel=false;;
    *) fail "unknown value for CIRROS_PARALLEL=$CIRROS_PARALLEL";;
esac

if $parallel; then
    parallel --ungroup ${jobs_flag} \
        "$0" "$VER" build_arch quiet {} ::: ${ARCHES}
else
    for arch in ${ARCHES}; do
      build_arch "$arch"
    done;
fi

for arch in ${ARCHES}; do
  mkdir -p "$OUT/stage/$arch"
done

logevent "start bundling" -
for arch in ${ARCHES}; do
  case "$arch" in
     powerpc|ppc*|aarch64) size=96M;;
     *) size="";;
  esac
  sudo ./bin/bundle -v ${size:+--size=$size} --arch="$arch" \
     "$OUT/build/$arch/rootfs.tar" \
     ./download/kernel-$arch.tar.gz "$OUT/stage/$arch";
done
logevent "finish bundling"

sudo chown -R $USER:$USER "$OUT/stage"

mkdir -p "$OUT/release"

#srctgz="$OUT/release/cirros-$VER-source.tar.gz"
#bzr export -r "tag:$VER" --format=tgz --root="cirros-$VER" "$srctgz"
#echo "wrote source tgz: $srctgz"
if ! $daily; then
  ( srcd="$PWD" && tmpd=$(mktemp -d) && cd "$tmpd" &&
    bzr branch "$srcd" -r tag:$VER cirros-$VER &&
    rm -Rf cirros-$VER/.bzr &&
    echo "$VER" > "cirros-$VER/src/etc/cirros/version" &&
    tar cvzf - cirros-$VER ) > "$OUT/release/cirros-$VER-source.tar.gz"
fi

rm -f "$OUT/stage"/*/"$pre"*
for arch in ${ARCHES}; do
  p=$pre-$arch
  ( cd "$OUT/stage/$arch" &&
    ln kernel $p-vmlinuz && ln kernel $p-kernel &&
    ln initramfs $p-initrd && ln initramfs $p-initramfs &&
    ln part.img $p-rootfs.img &&
    ln blank.img $p-blank.img &&
    ln disk.img $p-disk.img &&
    ln filesys.tar.gz $p-lxc.tar.gz &&
    true
  ); done

logevent "start populating release" -
for arch in ${ARCHES}; do
  p=$pre-$arch
  ( cd "$OUT/stage/$arch" &&
    cp $p-kernel $p-initramfs $p-lxc.tar.gz "$OUT/release/" &&
    gzip -9 -c $p-rootfs.img > $OUT/release/$p-rootfs.img.gz ) &&
  ( cd "$OUT/stage/$arch" &&
    tar cvzf - $p-blank.img $p-vmlinuz $p-initrd ) > \
    "$OUT/release/$p-uec.tar.gz"
  [ "$arch" = "arm" ] ||
     cp "$OUT/stage/$arch/$p-disk.img" "$OUT/release/$p-disk.img"
done

mkdir -p "$OUT/release/buildroot_rootfs"
for arch in ${ARCHES}; do
  t="$OUT/release/buildroot_rootfs/buildroot-$VER-$arch.tar"
  cp "$OUT/build/$arch/rootfs.tar" "$t" && gzip --force -9 "$t"
done

chmod u+rwX,go+rX -R "$OUT/release/"* 

sumfiles=$(cd "$OUT/release" && for f in *; do
   [ -f "$f" -a "$f" != MD5SUMS ] && echo "$f"; done)
( cd "$OUT/release" && md5sum $sumfiles > MD5SUMS )

logevent "finish populate release" -
msg "output in $OUT/release"
msg "entire process took $SECONDS seconds"
logevent "finished" "$tstart"
