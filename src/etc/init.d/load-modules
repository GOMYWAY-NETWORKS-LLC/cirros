#!/bin/sh
# vi: ts=4 noexpandtab
# load modules

loadmods() {
	local line
	while read line; do
		line="${line%%#*}"
		[ -n "$line" ] || continue
		if [ ! -d /sys/module/$line ]; then
                        case "$line" in
                            # in Ubuntu vfat uses cp437 and iso8859-1
                            vfat|nls_cp437|nls_iso8859-1)
                                grep vfat /proc/filesystems >/dev/null
                                if [ 1 -eq $? ]; then
                                    modprobe $line
                                fi
                                ;;
                            isofs)
                                grep iso9660 /proc/filesystems >/dev/null
                                if [ 1 -eq $? ]; then
                                    modprobe $line
                                fi
                                ;;
                            # sr_mod depends on sg and cdrom
                            cdrom|sr_mod|sg)
                                if [ ! -d /sys/module/sr_mod ]; then
                                    modprobe $line
                                fi
                                ;;
                            qemu_fw_cfg)  # present in Linux 4.6+
                                minimum_kernel=4.6
                                current_kernel=$(uname -r)
                                min=$(echo -e $minimum_kernel"\n"$current_kernel | sort -n | head -n1)
                                if [ $min = $minimum_kernel ]; then
                                    modprobe $line
                                fi
                                ;;
                            *)
                                modprobe $line
                                ;;
                        esac
		fi
	done
}

parse_modules() {
	local f="$1" arch="$2" march="" comment="" modinfo="" oifs="$IFS"
	local x="" found=false
	[ -f "$f" ] || return 1
	case "$arch" in
		i?86) march=",i386,x86,";;
		amd64|x86_64) march=",x86_64,x86,";;
		ppc64|powerpc) march=",powerpc,ppc64,";;
		arm*) march=",arm,$arch,";;
	esac
	while read line; do
		modinfo=${line%%#*}
		[ "$modinfo" = "$line" ] && comment="" ||
			comment="${line#${modinfo}#}"
		[ "${comment#*arch=}" = "$comment" ] &&
			{ echo "$modinfo"; continue; }
		found=false
		for tok in $comment; do
			[ "${tok#arch=}" != "$tok" ] || continue
			IFS=","; set -- ${tok#arch=}; IFS="$oifs";
			[ $# -eq 0 ] && continue
			for x in "$@"; do
				[ "${march#*,$x,}" != "$march" ] &&
					{ echo "$modinfo"; found=true; break; }
				shift;
			done
			$found && break
		done
	done < "$f"
}

MODULES_FILE="/etc/modules"

case "$1" in
	start)
		lxc-is-container && exit 0
		if [ -f "$MODULES_FILE" ]; then
			[ -d "/lib/modules/$(uname -r)" ] || exit 0
			march=$(uname -m)
			parse_modules "$MODULES_FILE" "$march" | loadmods
			[ "$march" = "ppc64" ] && sleep 1
		fi
		;;
	stop|restart|reload) : ;;
	parse_modules)
		parse_modules "$2" "$3";;
	*)
		echo $"Usage: $0 {start}"
		exit 1
esac

exit $?
